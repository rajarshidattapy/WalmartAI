<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Supply Chain Forecast</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      padding: 0;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #222;
      min-height: 100vh;
      min-width: 100vw;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      color: #0071ce;
      letter-spacing: 1px;
      font-weight: 700;
      text-shadow: 0 4px 12px rgba(0, 113, 206, 0.3);
      margin-top: 0;
      font-size: 2.5rem;
    }
    .container {
      width: 100%;
      max-width: 1400px;
      min-height: 100vh;
      margin: 0 auto;
      background: #fff;
      padding: 32px 24px 24px 24px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 8px 32px rgba(0, 113, 206, 0.1);
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .analytics-bar, .legend, #results, table, canvas#demandChart {
      max-width: 100%;
      margin-left: auto;
      margin-right: auto;
    }
    #results, table, canvas#demandChart {
      overflow-x: auto;
    }
    .analytics-bar {
      flex-wrap: wrap;
      gap: 14px;
      justify-content: center;
      margin-bottom: 24px;
      display: flex;
    }
    .analytics-btn {
      min-width: 180px;
      text-align: center;
      margin-bottom: 6px;
      background: linear-gradient(135deg, #0071ce 0%, #005fa3 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(0, 113, 206, 0.25), 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .analytics-btn:hover {
      background: linear-gradient(135deg, #ffc220 0%, #ffe082 100%);
      color: #222;
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 12px 35px rgba(255, 194, 32, 0.3), 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    .analytics-btn:active {
      transform: translateY(-2px) scale(1.01);
    }
    .legend {
      gap: 24px;
      margin: 24px 0 18px 0;
      justify-content: center;
      flex-wrap: wrap;
    }
    .legend-item {
      min-width: 120px;
      justify-content: flex-start;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      color: #222;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .legend-square {
      width: 18px;
      height: 18px;
      display: inline-block;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    .legend-high { background: #0071ce; }
    .legend-medium { background: #ffc220; }
    .legend-low { background: #43b02a; }
    .controls-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .search-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .search-input {
      padding: 12px 16px;
      background: #fff;
      color: #222;
      border: 2px solid #0071ce;
      border-radius: 10px;
      font-size: 1rem;
      outline: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 113, 206, 0.1);
      min-width: 200px;
    }
    .search-input:focus {
      border-color: #ffc220;
      box-shadow: 0 6px 20px rgba(255, 194, 32, 0.2);
    }
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    .search-result-item {
      padding: 10px 16px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background 0.2s;
    }
    .search-result-item:hover {
      background: #f8f9fa;
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    label {
      color: #0071ce;
      font-weight: 600;
      font-size: 1rem;
      text-shadow: 0 1px 3px rgba(0, 113, 206, 0.2);
    }
    select {
      padding: 12px 16px;
      margin: 0 12px;
      background: #fff;
      color: #222;
      border: 2px solid #0071ce;
      border-radius: 10px;
      font-size: 1rem;
      outline: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 113, 206, 0.1);
      min-width: 150px;
    }
    select:focus {
      border-color: #ffc220;
      box-shadow: 0 6px 20px rgba(255, 194, 32, 0.2);
    }
    #results {
      margin: 28px 0 0 0;
      padding: 20px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 15px;
      min-height: 40px;
      display: none;
      color: #222;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      width: 100%;
      overflow-x: auto;
    }
    table {
      width: 100%;
      margin-top: 24px;
      border-collapse: collapse;
      background: #fff;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
      max-width: 100%;
      font-size: 1rem;
    }
    th, td {
      border: none;
      padding: 15px 12px;
      text-align: center;
      min-width: 120px;
    }
    th {
      background: linear-gradient(135deg, #0071ce 0%, #005fa3 100%);
      color: #fff;
      font-weight: 600;
      font-size: 1.05rem;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
    td {
      color: #222;
      font-size: 1rem;
      border-bottom: 1px solid #f0f0f0;
    }
    tr:hover {
      background: rgba(0, 113, 206, 0.05);
    }
    .high {
      color: #0071ce;
      font-weight: bold;
    }
    .medium {
      color: #ffc220;
      font-weight: bold;
    }
    .low {
      color: #43b02a;
      font-weight: bold;
    }
    canvas#demandChart {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 15px;
      margin-top: 18px;
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
      width: 100% !important;
      max-width: 100%;
      height: 400px !important;
      display: block;
      padding: 20px;
    }
    .chart-title {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      color: #0071ce;
      margin-bottom: 20px;
      text-shadow: 0 2px 8px rgba(0, 113, 206, 0.2);
    }
    /* Custom scrollbar for modern look */
    ::-webkit-scrollbar {
      width: 12px;
      background: #f0f0f0;
    }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #0071ce 0%, #005fa3 100%);
      border-radius: 6px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #005fa3 0%, #004080 100%);
    }
    ::selection {
      background: #ffc220;
      color: #222;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“¦ Supply Chain Forecast</h1>
    <p style="text-align:center; color: #666; font-size: 1.1rem; margin-bottom: 30px;">Optimize inventory with AI-driven demand predictions</p>

    <!-- Demand Legend -->
    <div class="legend">
      <div class="legend-item"><span class="legend-square legend-high"></span> High Demand</div>
      <div class="legend-item"><span class="legend-square legend-medium"></span> Medium Demand</div>
      <div class="legend-item"><span class="legend-square legend-low"></span> Low Demand</div>
    </div>

    <!-- Analytics Buttons -->
    <div class="analytics-bar">
      <button class="analytics-btn" onclick="runAnalytic('on_time_delivery_rate')">On-time delivery rate</button>
      <button class="analytics-btn" onclick="runAnalytic('avg_lead_time')">Average delivery lead-time</button>
      <button class="analytics-btn" onclick="runAnalytic('supplier_otif_leaderboard')">Supplier OTIF leaderboard</button>
      <button class="analytics-btn" onclick="runAnalytic('delay_heatmap')">Delay heat-map by location</button>
      <button class="analytics-btn" onclick="runAnalytic('units_received_vs_planned')">Units received vs planned</button>
      <button class="analytics-btn" onclick="runAnalytic('rolling_lateness_trend')">Rolling 3-month lateness trend</button>
      <button class="analytics-btn" onclick="runAnalytic('pareto_late_units')">Pareto (80/20) of late units</button>
      <button class="analytics-btn" onclick="runAnalytic('scatter_leadtime_ordersize')">Scatter: lead-time vs order size</button>
      <button class="analytics-btn" onclick="runAnalytic('calendar_inbound_volume')">Calendar of inbound volume</button>
      <button class="analytics-btn" onclick="runAnalytic('expected_vs_actual_gap')">Expected vs actual delivery gap</button>
    </div>

    <!-- Results Section -->
    <div id="results"></div>

    <!-- Controls Section -->
    <div class="controls-section">
      <div class="control-group">
        <label>Location:</label>
        <select id="locationSelect">
          <option>All</option>
          {% for loc in locations %}
          <option>{{ loc }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="control-group">
        <label>Month:</label>
        <select id="monthSelect">
          {% for m in months %}
          <option>{{ m }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="search-container">
        <label>Search Products:</label>
        <input type="text" id="productSearch" class="search-input" placeholder="Type to search products...">
        <div id="searchResults" class="search-results"></div>
      </div>
    </div>

    <canvas id="demandChart" height="150"></canvas>

    <div id="paginationControls" style="text-align:center; margin: 32px 0 0 0;">
      <button id="prevPage" class="analytics-btn" style="min-width:100px;">Previous</button>
      <span id="pageInfo" style="margin: 0 18px; font-weight:600; color:#0071ce;"></span>
      <button id="nextPage" class="analytics-btn" style="min-width:100px;">Next</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Location</th>
          <th>Product</th>
          <th>Month</th>
          <th>Expected Units</th>
          <th>Demand Level</th>
        </tr>
      </thead>
      <tbody id="demandTableBody"></tbody>
    </table>
  </div>

  <script>
    const chartCtx = document.getElementById("demandChart").getContext("2d");
    let demandChart;
    let searchTimeout;
    let allData = [];
    let currentPage = 1;
    const pageSize = 6;

    async function updateDashboard(page = 1) {
      const location = document.getElementById("locationSelect").value;
      const month = document.getElementById("monthSelect").value;
      const productSearch = document.getElementById("productSearch").value;

      const res = await fetch('/get_data', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ location, month, product_search: productSearch })
      });

      allData = await res.json();
      currentPage = page;
      renderPaginatedChartAndTable();
    }

    function renderPaginatedChartAndTable() {
      const totalPages = Math.ceil(allData.length / pageSize) || 1;
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;
      const startIdx = (currentPage - 1) * pageSize;
      const endIdx = startIdx + pageSize;
      const data = allData.slice(startIdx, endIdx);

      // Chart
      const labels = data.map(d => d.PRODUCT_NAME);
      const units = data.map(d => d.ORDER_UNITS);
      const colors = data.map(d => d.Demand_Level === 'High' ? '#0071ce' : (d.Demand_Level === 'Medium' ? '#ffc220' : '#43b02a'));

      if (demandChart) demandChart.destroy();
      demandChart = new Chart(chartCtx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Expected Units',
            data: units,
            backgroundColor: colors,
            borderColor: colors.map(c => c + '80'),
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: '',
              color: '#0071ce',
              font: { size: 22, weight: 'bold', family: 'Segoe UI, Roboto, Arial, sans-serif' },
              padding: { top: 32, bottom: 28 }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#0071ce',
              borderWidth: 1,
              cornerRadius: 8,
              callbacks: {
                label: ctx => `${ctx.parsed.y.toLocaleString()} units`
              }
            }
          },
          layout: {
            padding: {
              bottom: 40
            }
          },
          scales: {
            y: { 
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)',
                drawBorder: false
              },
              ticks: {
                color: '#666',
                font: {
                  weight: '500'
                },
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: '#666',
                font: {
                  weight: '500'
                },
                autoSkip: false,
                maxRotation: 45,
                minRotation: 30,
                callback: function(value, index, values) {
                  let label = this.getLabelForValue(value);
                  if (label.length > 16) {
                    return label.slice(0, 15) + '...';
                  }
                  return label;
                }
              }
            }
          }
        }
      });

      // Table
      const tbody = document.getElementById("demandTableBody");
      tbody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.SHIPPING_LOCATION}</td>
          <td>${row.PRODUCT_NAME}</td>
          <td>${row.MONTH}</td>
          <td>${row.ORDER_UNITS}</td>
          <td class="${row.Demand_Level.toLowerCase()}">${row.Demand_Level}</td>
        `;
        tbody.appendChild(tr);
      });

      // Pagination controls
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = currentPage === totalPages;
    }

    document.getElementById('prevPage').addEventListener('click', function() {
      if (currentPage > 1) {
        currentPage--;
        renderPaginatedChartAndTable();
      }
    });
    document.getElementById('nextPage').addEventListener('click', function() {
      const totalPages = Math.ceil(allData.length / pageSize) || 1;
      if (currentPage < totalPages) {
        currentPage++;
        renderPaginatedChartAndTable();
      }
    });

    // Product search functionality
    document.getElementById("productSearch").addEventListener("input", function(e) {
      const searchTerm = e.target.value;
      const searchResults = document.getElementById("searchResults");
      
      clearTimeout(searchTimeout);
      
      if (searchTerm.length < 2) {
        searchResults.style.display = 'none';
        return;
      }
      
      searchTimeout = setTimeout(async () => {
        try {
          const res = await fetch('/search_products', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ search_term: searchTerm })
          });
          const products = await res.json();
          
          if (products.length > 0) {
            searchResults.innerHTML = products.map(product => 
              `<div class="search-result-item" onclick="selectProduct('${product}')">${product}</div>`
            ).join('');
            searchResults.style.display = 'block';
          } else {
            searchResults.style.display = 'none';
          }
        } catch (error) {
          console.error('Search error:', error);
        }
      }, 300);
    });

    function selectProduct(productName) {
      document.getElementById("productSearch").value = productName;
      document.getElementById("searchResults").style.display = 'none';
      updateDashboard();
    }

    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
      const searchContainer = document.querySelector('.search-container');
      const searchResults = document.getElementById("searchResults");
      
      if (!searchContainer.contains(e.target)) {
        searchResults.style.display = 'none';
      }
    });

    document.getElementById("locationSelect").addEventListener("change", () => updateDashboard(1));
    document.getElementById("monthSelect").addEventListener("change", () => updateDashboard(1));
    window.onload = () => updateDashboard(1);

    // Analytics button logic
    async function runAnalytic(type) {
      const location = document.getElementById("locationSelect").value;
      const month = document.getElementById("monthSelect").value;
      const resultsDiv = document.getElementById("results");
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = 'Loading...';
      try {
        const res = await fetch(`/analytic/${type}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ location, month })
        });
        const data = await res.json();
        resultsDiv.innerHTML = renderAnalyticResult(type, data);
      } catch (e) {
        resultsDiv.innerHTML = 'Error loading analytic.';
      }
    }

    function renderAnalyticResult(type, data) {
      switch(type) {
        case 'on_time_delivery_rate':
          return `<b>On-time Delivery Rate:</b> <span style='color: #1976d2;'>${data.rate}</span>`;
        case 'avg_lead_time':
          return `<b>Average Delivery Lead-time:</b> <span style='color: #1976d2;'>${data.average_lead_time_days} days</span>`;
        case 'supplier_otif_leaderboard':
          return `<b>Supplier OTIF Leaderboard:</b><br><table style='margin:auto;'><tr><th>Supplier</th><th>OTIF</th></tr>` +
            data.leaderboard.map(row => `<tr><td>${row.supplier}</td><td>${row.otif}</td></tr>`).join('') + '</table>';
        case 'delay_heatmap':
          return `<b>Delay Heat-map by Location:</b><br><table style='margin:auto;'><tr><th>Location</th><th>Delays</th></tr>` +
            data.heatmap.map(row => `<tr><td>${row[0]}</td><td>${row[1]}</td></tr>`).join('') + '</table>';
        case 'units_received_vs_planned':
          return `<b>Units Received vs Planned:</b><br>Received: <b>${data.received}</b><br>Planned: <b>${data.planned}</b>`;
        case 'rolling_lateness_trend':
          return `<b>Rolling 3-month Lateness Trend:</b><br><table style='margin:auto;'><tr><th>Month</th><th>Late Orders</th></tr>` +
            data.trend.map(row => `<tr><td>${row.month}</td><td>${row.late}</td></tr>`).join('') + '</table>';
        case 'pareto_late_units':
          return `<b>Pareto (80/20) of Late Units:</b><br><table style='margin:auto;'><tr><th>Supplier</th><th>Late Units</th></tr>` +
            data.pareto.map(row => `<tr><td>${row.supplier}</td><td>${row.late_units}</td></tr>`).join('') + '</table>';
        case 'scatter_leadtime_ordersize':
          return `<b>Scatter: Lead-time vs Order Size:</b><br><table style='margin:auto;'><tr><th>Order Units</th><th>Lead Time (days)</th></tr>` +
            data.scatter.map(row => `<tr><td>${row.order_units}</td><td>${row.lead_time}</td></tr>`).join('') + '</table>';
        case 'calendar_inbound_volume':
          return `<b>Calendar of Inbound Volume:</b><br><table style='margin:auto;'><tr><th>Date</th><th>Units</th></tr>` +
            data.calendar.map(row => `<tr><td>${row.date}</td><td>${row.units}</td></tr>`).join('') + '</table>';
        case 'expected_vs_actual_gap':
          return `<b>Expected vs Actual Delivery Gap:</b><br><table style='margin:auto;'><tr><th>Date</th><th>Gap (days)</th></tr>` +
            data.gaps.map(row => `<tr><td>${row.date}</td><td>${row.gap_days}</td></tr>`).join('') + '</table>';
        default:
          return '<i>No data available.</i>';
      }
    }
  </script>
</body>
</html>
